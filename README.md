## Р§С‚Рѕ РґРµР»Р°РµС‚ Р±РѕС‚

Р‘РѕС‚ РїРѕР»СѓС‡Р°РµС‚ **РєР°СЂС‚РёРЅРєСѓ РёР· РЅРѕРІРѕРіРѕ РїРѕСЃС‚Р° РІ TelegramвЂ‘РєР°РЅР°Р»Рµ**, РіРµРЅРµСЂРёСЂСѓРµС‚ **СЃРјРµС€РЅСѓСЋ РїРѕРґРїРёСЃСЊ** С‡РµСЂРµР· **AIвЂ‘Р°РіРµРЅС‚Р° РІ timeweb.cloud** Рё РїСѓР±Р»РёРєСѓРµС‚ РїРѕРґРїРёСЃСЊ **РІ РєРѕРјРјРµРЅС‚Р°СЂРёСЏС… Рє РїРѕСЃС‚Сѓ** (РІ РїСЂРёРІСЏР·Р°РЅРЅРѕРј С‡Р°С‚Рµ РѕР±СЃСѓР¶РґРµРЅРёР№, reply Рє вЂњdiscussion messageвЂќ).

## РўСЂРµР±РѕРІР°РЅРёСЏ РІ Telegram

- **РЈ РєР°РЅР°Р»Р° РґРѕР»Р¶РЅС‹ Р±С‹С‚СЊ РІРєР»СЋС‡РµРЅС‹ РєРѕРјРјРµРЅС‚Р°СЂРёРё** (РїСЂРёРІСЏР·Р°РЅ С‡Р°С‚ РѕР±СЃСѓР¶РґРµРЅРёР№ / linked chat).
- Р‘РѕС‚ РґРѕР»Р¶РµРЅ Р±С‹С‚СЊ **Р°РґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂРѕРј РІ РєР°РЅР°Р»Рµ** (С‡С‚РѕР±С‹ РїРѕР»СѓС‡Р°С‚СЊ `channel_post`).
- Р‘РѕС‚ РґРѕР»Р¶РµРЅ РёРјРµС‚СЊ РїСЂР°РІРѕ **РїРёСЃР°С‚СЊ СЃРѕРѕР±С‰РµРЅРёСЏ** РІ С‡Р°С‚Рµ РѕР±СЃСѓР¶РґРµРЅРёР№ (РѕР±С‹С‡РЅРѕ РґРѕСЃС‚Р°С‚РѕС‡РЅРѕ Р±С‹С‚СЊ СѓС‡Р°СЃС‚РЅРёРєРѕРј/Р°РґРјРёРЅРѕРј).
- Р•СЃР»Рё Р±РѕС‚ вЂњРЅРµ РІРёРґРёС‚вЂќ РїРѕСЃС‚С‹: РїСЂРѕРІРµСЂСЊС‚Рµ, С‡С‚Рѕ РѕРЅ РґРѕР±Р°РІР»РµРЅ РёРјРµРЅРЅРѕ РІ **РєР°РЅР°Р»** (РЅРµ С‚РѕР»СЊРєРѕ РІ С‡Р°С‚ РѕР±СЃСѓР¶РґРµРЅРёР№) Рё РёРјРµРµС‚ РїСЂР°РІР° **Read messages / Post messages**.

## РџРµСЂРµРјРµРЅРЅС‹Рµ РѕРєСЂСѓР¶РµРЅРёСЏ

РЎРїРёСЃРѕРє вЂ” РІ `env.example`.

РљР»СЋС‡РµРІС‹Рµ:

- **`TELEGRAM_BOT_TOKEN`**: С‚РѕРєРµРЅ РѕС‚ `@BotFather`
- **`PUBLIC_BASE_URL`**: РїСѓР±Р»РёС‡РЅС‹Р№ URL РїСЂРёР»РѕР¶РµРЅРёСЏ РІ Timeweb App Platform (HTTPS)
- **`TELEGRAM_WEBHOOK_PATH_SECRET`**: СЃРµРєСЂРµС‚ РІ РїСѓС‚Рё РІРµР±С…СѓРєР°
- **`TELEGRAM_WEBHOOK_SECRET_TOKEN`**: СЃРµРєСЂРµС‚ РґР»СЏ Р·Р°РіРѕР»РѕРІРєР° Telegram `X-Telegram-Bot-Api-Secret-Token`
- **`TIMEWEB_AI_API_KEY`**, **`TIMEWEB_AI_MODEL`**, **`TIMEWEB_AI_BASE_URL`**
- **`TIMEWEB_AI_CHAT_PATH`**: РїСѓС‚СЊ Рє endpoint chatвЂ‘completions (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ `/v1/chat/completions`)
- **`TELEGRAM_ALLOWED_CHANNEL_ID` / `TELEGRAM_ALLOWED_CHANNEL_IDS`**: РѕРіСЂР°РЅРёС‡РµРЅРёРµ РЅР° СЃРїРёСЃРѕРє СЂР°Р·СЂРµС€С‘РЅРЅС‹С… РєР°РЅР°Р»РѕРІ (С‡РµСЂРµР· Р·Р°РїСЏС‚СѓСЋ)
- **`TIMEWEB_AI_USE_POST_CAPTION`**: РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РїРѕРґРїРёСЃСЊ РїРѕСЃС‚Р° РєР°Рє РєРѕРЅС‚РµРєСЃС‚ (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ `true`)
- **`TIMEWEB_AI_EMOJI_RATIO`**: РґРѕР»СЏ emojiвЂ‘СЂРµР°РєС†РёР№ (0.0..1.0), РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ `0.3`
- **`DATABASE_URL`** / **`DATABASE_HOST`**/**`DATABASE_NAME`**/**`DATABASE_USER`**/**`DATABASE_PASSWORD`**: РїРѕРґРєР»СЋС‡РµРЅРёРµ Рє Postgres (РґР»СЏ СЂРµР¶РёРјР° РѕРїСЂРѕСЃРѕРІ)
- **`DAILY_POLL_ENABLED`** / **`DAILY_POLL_CHANNEL_IDS`**: РІРєР»СЋС‡РµРЅРёРµ РґРЅРµРІРЅРѕРіРѕ РѕРїСЂРѕСЃР° Рё СЃС‚СЂРѕРіРёР№ СЃРїРёСЃРѕРє РєР°РЅР°Р»РѕРІ

## РљР°Рє СЂР°Р±РѕС‚Р°РµС‚ РїСЂРёРІСЏР·РєР° вЂњРїРѕСЃС‚ в†’ РєРѕРјРјРµРЅС‚Р°СЂРёРёвЂќ

Telegram С…СЂР°РЅРёС‚ РєРѕРјРјРµРЅС‚Р°СЂРёРё Рє РїРѕСЃС‚Р°Рј РєР°РЅР°Р»Р° РІ РѕС‚РґРµР»СЊРЅРѕРј С‡Р°С‚Рµ РѕР±СЃСѓР¶РґРµРЅРёР№.  
Р”Р»СЏ С‚РѕРіРѕ С‡С‚РѕР±С‹ РѕС‚РІРµС‚РёС‚СЊ вЂњРІ РєРѕРјРјРµРЅС‚Р°СЂРёРё Рє РїРѕСЃС‚СѓвЂќ, Р±РѕС‚ РґРµР»Р°РµС‚:

1) `getDiscussionMessage(channel_id, channel_message_id)` вЂ” РїРѕР»СѓС‡Р°РµС‚ СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РµРµ СЃРѕРѕР±С‰РµРЅРёРµ РІ С‡Р°С‚Рµ РѕР±СЃСѓР¶РґРµРЅРёР№  
2) `sendMessage(discussion_chat_id, reply_to_message_id=discussion_message_id)` вЂ” РїСѓР±Р»РёРєСѓРµС‚ РїРѕРґРїРёСЃСЊ replyвЂ™РµРј

## Р›РѕРєР°Р»СЊРЅС‹Р№ Р·Р°РїСѓСЃРє

1) РЈСЃС‚Р°РЅРѕРІРёС‚СЊ Р·Р°РІРёСЃРёРјРѕСЃС‚Рё:

```bash
python -m venv .venv
. .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

2) РЎРѕР·РґР°С‚СЊ `.env` **Р»РѕРєР°Р»СЊРЅРѕ** РїРѕ РѕР±СЂР°Р·С†Сѓ `env.example` (С„Р°Р№Р» РЅРµ РєРѕРјРјРёС‚РёС‚СЊ).

3) Р—Р°РїСѓСЃРє:

```bash
uvicorn main:api --host 0.0.0.0 --port 8080
```

Р›РѕРєР°Р»СЊРЅРѕ webhook СЂР°Р±РѕС‚Р°С‚СЊ РЅРµ Р±СѓРґРµС‚ Р±РµР· РїСѓР±Р»РёС‡РЅРѕРіРѕ HTTPS URL (РЅСѓР¶РµРЅ ngrok/Cloudflare Tunnel), РїРѕСЌС‚РѕРјСѓ СѓРґРѕР±РЅРµРµ СЃСЂР°Р·Сѓ С‚РµСЃС‚РёСЂРѕРІР°С‚СЊ РІ Timeweb App Platform.

## Р”РµРїР»РѕР№ РІ timeweb.cloud App Platform

1) **РЎРѕР·РґР°Р№С‚Рµ СЂРµРїРѕР·РёС‚РѕСЂРёР№** (GitHub/GitLab) Рё Р·Р°Р»РµР№С‚Рµ С‚СѓРґР° СЌС‚РѕС‚ РїСЂРѕРµРєС‚.
2) Р’ РїР°РЅРµР»Рё timeweb.cloud РѕС‚РєСЂРѕР№С‚Рµ **App Platform в†’ РЎРѕР·РґР°С‚СЊ РїСЂРёР»РѕР¶РµРЅРёРµ**.
3) Р’С‹Р±РµСЂРёС‚Рµ **Deploy from repository** Рё СѓРєР°Р¶РёС‚Рµ СЂРµРїРѕР·РёС‚РѕСЂРёР№/РІРµС‚РєСѓ.
4) РўРёРї РїСЂРёР»РѕР¶РµРЅРёСЏ: **Dockerfile** (РїСЂРѕРµРєС‚ СѓР¶Рµ СЃРѕРґРµСЂР¶РёС‚ `Dockerfile`).
5) Р’ РЅР°СЃС‚СЂРѕР№РєР°С… РїСЂРёР»РѕР¶РµРЅРёСЏ РґРѕР±Р°РІСЊС‚Рµ **Environment variables** РёР· `env.example`:
   - РѕР±СЏР·Р°С‚РµР»СЊРЅРѕ СѓРєР°Р¶РёС‚Рµ `PUBLIC_BASE_URL` вЂ” СЌС‚Рѕ РґРѕРјРµРЅ/URL, РєРѕС‚РѕСЂС‹Р№ РІС‹РґР°СЃС‚ App Platform РІР°С€РµРјСѓ РїСЂРёР»РѕР¶РµРЅРёСЋ
   - `PORT` РѕР±С‹С‡РЅРѕ РІС‹СЃС‚Р°РІР»СЏРµС‚ РїР»Р°С‚С„РѕСЂРјР° СЃР°РјР° (РјС‹ РµРіРѕ РїРѕРґРґРµСЂР¶РёРІР°РµРј)
6) Р”РѕР¶РґРёС‚РµСЃСЊ РґРµРїР»РѕСЏ, РїСЂРѕРІРµСЂСЊС‚Рµ `GET /health` РїРѕ РІР°С€РµРјСѓ РїСѓР±Р»РёС‡РЅРѕРјСѓ РґРѕРјРµРЅСѓ.

РџРѕСЃР»Рµ СЃС‚Р°СЂС‚Р° РїСЂРёР»РѕР¶РµРЅРёРµ **СЃР°РјРѕ РІС‹Р·РѕРІРµС‚ `setWebhook`** РЅР° `PUBLIC_BASE_URL/webhook/<TELEGRAM_WEBHOOK_PATH_SECRET>`.

## Р§Р°СЃС‚С‹Рµ РїСЂРѕР±Р»РµРјС‹

- **Р‘РѕС‚ РЅРµ РїРёС€РµС‚ РєРѕРјРјРµРЅС‚Р°СЂРёРё**: РїСЂРѕРІРµСЂСЊС‚Рµ, С‡С‚Рѕ РІРєР»СЋС‡РµРЅС‹ РєРѕРјРјРµРЅС‚Р°СЂРёРё, Р±РѕС‚ РґРѕР±Р°РІР»РµРЅ РІ linked chat Рё РІРёРґРёС‚ Р°РІС‚РѕС„РѕСЂРІР°СЂРґС‹ (privacy mode Р»СѓС‡С€Рµ РѕС‚РєР»СЋС‡РёС‚СЊ).
- **РќРµС‚ Р°РїРґРµР№С‚РѕРІ**: Р±РѕС‚ РЅРµ Р°РґРјРёРЅ РєР°РЅР°Р»Р° РёР»Рё webhook РЅРµ СѓСЃС‚Р°РЅРѕРІР»РµРЅ (РїСЂРѕРІРµСЂСЊС‚Рµ Р»РѕРіРё РїСЂРёР»РѕР¶РµРЅРёСЏ Рё С‡С‚Рѕ `PUBLIC_BASE_URL` РІРµСЂРЅС‹Р№).
- **403 РЅР° webhook**: РЅРµ СЃРѕРІРїР°РґР°РµС‚ `TELEGRAM_WEBHOOK_SECRET_TOKEN` (Telegram РїСЂРёСЃС‹Р»Р°РµС‚ РµРіРѕ РІ Р·Р°РіРѕР»РѕРІРєРµ).

## Р’Р°Р¶РЅРѕ РїСЂРѕ Timeweb AIвЂ‘Р°РіРµРЅС‚Р°

Р’ `timeweb_ai.py` РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ **OpenAIвЂ‘СЃРѕРІРјРµСЃС‚РёРјС‹Р№** РІС‹Р·РѕРІ:

- `POST {TIMEWEB_AI_BASE_URL}{TIMEWEB_AI_CHAT_PATH}`
- `Authorization: Bearer {TIMEWEB_AI_API_KEY}`
- `model = TIMEWEB_AI_MODEL`
- РєР°СЂС‚РёРЅРєР° РѕС‚РїСЂР°РІР»СЏРµС‚СЃСЏ РєР°Рє `data:image/...;base64,...` (vision)

Р•СЃР»Рё РІР°С€ AIвЂ‘Р°РіРµРЅС‚ Timeweb РёСЃРїРѕР»СЊР·СѓРµС‚ РґСЂСѓРіРѕР№ URL/С„РѕСЂРјР°С‚ вЂ” СЃРєР°Р¶РёС‚Рµ РјРЅРµ СЃСЃС‹Р»РєСѓ РЅР° РІР°С€Сѓ СЃС‚СЂР°РЅРёС†Сѓ API/РїСЂРёРјРµСЂ curl, Рё СЏ РїРѕРґРіРѕРЅСЋ РєР»РёРµРЅС‚ РїРѕРґ С‚РѕС‡РЅС‹Р№ РєРѕРЅС‚СЂР°РєС‚.



